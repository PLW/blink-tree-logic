# The B-LInk tree code is based on research published by Kark Malbrain of
# the University of California, Berkeley.  The code is derived and re-written
# from original 'C' source code placed in the public domain by Karl Malbrain.
# See: http://arxiv.org/ftp/arxiv/papers/1009/1009.2764.pdf
# See: https://code.google.com/p/high-concurrency-btree/

# compile everything
g++ -O3 -o random_keys random_keys.cpp
g++ -O3 -o logger logger.cpp logger_test.cpp
g++ -O3 -o page page.cpp page_test.cpp
g++ -O3 -o latch logger.cpp page.cpp latchmgr.cpp latchmgr_test.cpp
g++ -O3 -o bufmgr logger.cpp blterr.cpp page.cpp latchmgr.cpp buffer_mgr.cpp buffer_mgr_test.cpp
g++ -O3 -o bltindex logger.cpp blterr.cpp page.cpp latchmgr.cpp buffer_mgr.cpp bltindex.cpp bltindex_test.cpp -lpthread

# create a file of random keys
./random_keys >keys.txt

# unit test page manager code (only makes sense for an existing index)
#    ./page FNAME PAGE_BIT_SIZE
./page testdb 15

# unit test thread-safe logging
./logger

# unit test latch manager
./latchmgr

# unit test buffer pool manager (only makes sense for an existing index)
#    ./bufmgr FNAME PAGE_BIT_SIZE
./bufmgr testdb 15

# test BLink Tree 
#    ./bltindex
#        -f dbname            - the name of the index file(s)
#        -c cmd,cmd,..        - list of: Audit, Write, Delete, Find, Scan, Count, one per thread
#        -k k_1,k_2,..        - matching list of source key files k_i, one per thread
#        -p PageBits          - page size in bits
#        -n PoolSize          - number of buffer pool mmapped page segments
#        -s SegBits           - segment size in pages in bits
#
# (e.g.) 32KB pages, 8192 segments of 32 pages each = 8GB total storage

rm -f testdb
./bltindex -f testdb -c Write -k keys.txt -p 15 -n 8192 -s 5
./bltindex -f testdb -c Scan,Find,Find -k keys.txt,keys.txt,keys.txt -p 15 -n 8192 -s 5

